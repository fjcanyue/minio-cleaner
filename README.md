# MinIO Cleaner

MinIO Cleaner 是一个用于自动清理 MinIO/S3 存储桶中过期文件的工具。它可以根据文件的年龄和大小条件，自动删除符合条件的文件，帮助您管理存储空间。

## 功能特性

- 支持按文件年龄清理（可配置最大保留天数）
- 支持按文件大小过滤（可配置最小文件大小）
- 支持并发处理，提高清理效率
- 提供预览模式（dry-run），可以在不实际删除文件的情况下查看清理效果
- 详细的日志记录，支持输出到文件
- 实时进度显示，包括处理文件数量和已删除空间大小

## 安装

### 从源码编译

```bash
# 克隆仓库
git clone <repository-url>
cd minio-cleaner

# 编译
go build -o minio-cleaner
```

## 配置

在运行之前，需要创建配置文件。您可以复制示例配置文件 `config.example.yaml` 并根据需要修改：

```yaml
minio:
  endpoint: "play.min.io"          # MinIO 服务器地址
  accessKeyId: "your-access-key"    # 访问密钥 ID
  secretAccessKey: "your-secret-key" # 访问密钥
  useSSL: true                      # 是否使用 SSL 连接
  bucket: "your-bucket"             # 要清理的存储桶名称

cleanup:
  maxAge: 365                       # 文件最大保留天数
  minSize: 5242880                  # 文件最小大小（字节），默认 5MB
  dryRun: true                      # 是否仅预览不实际删除
  workers: 5                        # 并发工作协程数
  logFile: "logs/cleaner.log"       # 日志文件路径
```

### 配置说明

#### MinIO 配置

- `endpoint`: MinIO 服务器地址
- `accessKeyId`: 访问密钥 ID
- `secretAccessKey`: 访问密钥
- `useSSL`: 是否使用 SSL 连接
- `bucket`: 要清理的存储桶名称

#### 清理配置

- `maxAge`: 文件最大保留天数，超过这个天数的文件将被清理
- `minSize`: 文件最小大小（字节），只有大于这个大小的文件才会被清理
- `dryRun`: 预览模式开关，设置为 true 时只显示要删除的文件而不实际删除
- `workers`: 并发工作协程数，用于控制清理任务的并发度
- `logFile`: 日志文件路径，程序会同时将日志输出到控制台和该文件

## 使用方法

```bash
# 使用默认配置文件路径（./config.yaml）
./minio-cleaner

# 指定配置文件路径
./minio-cleaner -config /path/to/config.yaml
```

### 使用建议

1. 首次使用时，建议先将 `dryRun` 设置为 `true`，查看将要删除的文件列表
2. 确认要删除的文件无误后，将 `dryRun` 设置为 `false` 执行实际清理
3. 根据文件数量和大小适当调整 `workers` 参数
4. 建议将 `logFile` 配置到单独的目录，方便查看历史记录

## 运行输出

程序运行时会显示如下信息：

- 清理任务的配置信息（时间阈值、最小文件大小等）
- 实时进度信息（已处理文件数、总文件数、删除文件数等）
- 删除的文件详情（文件名、大小、修改时间等）
- 最终的统计信息（总处理文件数、删除文件数、释放空间等）

程序日志输出示例如下：

```
2025/03/12 16:40:09 开始清理过程，阈值时间: 2024-07-15 16:40:09.9562059 +0800 CST, 最小文件大小: 5.00 MB
2025/03/12 16:40:12 总文件数: 41642
2025/03/12 16:40:14 发现需要清理的文件: xxx-user/weeklly/13769/2024-07-11/11/1720667891211/xxx-col.rar (大小: 5.82 MB, 修改时间: 2024-07-11 03:18:11.646 +0000 UTC)
2025/03/12 16:40:14 成功删除文件: xxx-user/weeklly/13769/2024-07-11/11/1720667891211/xxx-col.rar
2025/03/12 16:40:14 清理过程完成。总文件数: 41642, 已处理: 41641, 已删除: 1, 已删除大小: 5.82 MB
```

## 注意事项

1. 使用前请确保配置的访问密钥具有足够的权限（至少需要列举和删除对象的权限）
2. 删除操作不可恢复，请谨慎配置清理条件
3. 建议先使用预览模式（`dryRun: true`）确认要删除的文件
4. 如果文件数量较多，建议适当增加 `workers` 数量以提高效率
5. 程序会自动创建日志文件所在的目录